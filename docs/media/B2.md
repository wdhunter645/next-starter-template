# Backblaze B2 Storage Integration

This document describes the optional Backblaze B2 storage integration for media files.

## Overview

B2 integration is **optional** and feature-flagged. The site functions normally without it, but media upload/storage features will be unavailable.

When B2 is not configured:
- Admin endpoints return HTTP 503 (Service Unavailable)
- Clear error messages indicate missing configuration
- No crashes or build failures
- Site continues to function for other features

## Configuration

### Environment Variables

Add these to your `.env.local` or hosting platform:

```bash
# Backblaze B2 Configuration (OPTIONAL)
B2_KEY_ID=your_key_id_here
B2_APP_KEY=your_application_key_here
B2_BUCKET=your_bucket_id_here
B2_ENDPOINT=s3.us-east-005.backblazeb2.com
PUBLIC_B2_BASE_URL=https://your-bucket-name.s3.us-east-005.backblazeb2.com
```

### Getting B2 Credentials

1. **Create B2 Account**: Sign up at [backblaze.com/b2](https://www.backblaze.com/b2)
2. **Create Bucket**: 
   - Go to B2 Cloud Storage > Buckets
   - Click "Create a Bucket"
   - Choose bucket name and settings (private or public)
   - Note the bucket ID
3. **Create Application Key**:
   - Go to App Keys
   - Click "Add a New Application Key"
   - Grant permissions (readFiles, writeFiles, listBuckets, listFiles)
   - Copy the Key ID and Application Key immediately (shown only once)
4. **Get S3 Endpoint**:
   - Find your bucket's region (e.g., us-east-005)
   - Endpoint format: `s3.{region}.backblazeb2.com`
5. **Public URL** (if bucket is public):
   - Format: `https://{bucket-name}.s3.{region}.backblazeb2.com`
   - Or use Backblaze's friendly URL if configured

## API Endpoints

### POST /api/admin/b2/presign

Generate presigned upload URLs for client-side file uploads.

**Authentication**: Admin only

**Request**: POST (no body required for now)

**Responses**:
- **401** - Not authenticated
- **403** - Not admin
- **503** - B2 not configured (includes list of missing env vars)
- **200** - Success (when implemented)

**Example 503 Response** (B2 not configured):
```json
{
  "error": "Service unavailable",
  "reason": "B2 storage is not configured",
  "missing": ["B2_KEY_ID", "B2_APP_KEY", "B2_BUCKET", "B2_ENDPOINT"],
  "message": "B2 presigned URL generation requires environment variables"
}
```

### POST /api/admin/b2/sync

Sync local media to B2 storage (stub implementation).

**Authentication**: Admin only

**Request**: POST (no body required for now)

**Responses**:
- **401** - Not authenticated
- **403** - Not admin
- **503** - B2 not configured (includes list of missing env vars)
- **200** - Success (when implemented)

**Example 503 Response** (B2 not configured):
```json
{
  "error": "Service unavailable",
  "reason": "B2 storage is not configured",
  "missing": ["B2_KEY_ID", "B2_APP_KEY"],
  "message": "B2 sync requires environment variables"
}
```

## Implementation Status

### âœ… Completed
- [x] Admin-only endpoint protection
- [x] Graceful degradation with 503 when unconfigured
- [x] Clear error messages with missing variables
- [x] No CI/build crashes when B2 absent

### ðŸš§ TODO: Full Implementation
- [ ] Install AWS SDK or B2 SDK for S3-compatible operations
- [ ] Implement presigned URL generation
- [ ] Implement sync logic
- [ ] Add file upload UI in admin panel
- [ ] Add progress tracking for uploads
- [ ] Add file listing/management UI

## Testing

### Test without B2 configured
```bash
# Start dev server
npm run dev

# Try to access endpoints (should get 503)
curl -X POST http://localhost:3000/api/admin/b2/presign
# Expected: 401 (not authenticated)

# With admin session (once auth is implemented)
# Expected: 503 with missing variables list
```

### Test with B2 configured
```bash
# Set environment variables
export B2_KEY_ID="your_key_id"
export B2_APP_KEY="your_app_key"
export B2_BUCKET="your_bucket_id"
export B2_ENDPOINT="s3.us-east-005.backblazeb2.com"

# Start dev server
npm run dev

# Try endpoints (should return stub success)
curl -X POST http://localhost:3000/api/admin/b2/presign
# Expected: 401 or 403 (auth required)
```

## Security Notes

1. **Admin Only**: All B2 endpoints require admin authentication
2. **No Service Role**: Uses application keys, not privileged service keys
3. **Env Vars Only**: Credentials never in code or logs
4. **S3 Compatible**: Uses standard S3 API for compatibility
5. **Presigned URLs**: Client uploads directly to B2 (server never handles file data)

## Usage in Admin Panel

Once fully implemented, admins can:

1. **Upload Files**:
   - Request presigned URL from `/api/admin/b2/presign`
   - Upload file directly to B2 using presigned URL
   - Store file metadata in database

2. **Sync Media**:
   - Trigger sync via `/api/admin/b2/sync`
   - Review sync report
   - Verify files in B2 bucket

3. **Manage Files**:
   - List uploaded files
   - Delete files (via B2 API)
   - Generate public URLs

## Troubleshooting

### Error: "B2 storage is not configured"
- Check environment variables are set
- Verify variable names match exactly
- Restart server after setting env vars

### 401 Unauthorized
- You are not signed in
- Session may have expired
- TODO: Implement sign-in page

### 403 Forbidden
- You are signed in but not an admin
- Check `ADMIN_EMAILS` includes your email
- Email comparison is case-insensitive

### 503 Service Unavailable
- B2 is not configured (expected behavior when optional)
- Check the `missing` array in response
- Add missing environment variables

## Related Documentation

- [Admin Auth Gates](../ops/AUTH-GATES.md)
- [API Reference](../API_REFERENCE.md)
- [Configuration Reference](../CONFIGURATION_REFERENCE.md)

## External Resources

- [Backblaze B2 Documentation](https://www.backblaze.com/b2/docs/)
- [B2 S3 Compatible API](https://www.backblaze.com/b2/docs/s3_compatible_api.html)
- [AWS SDK for JavaScript](https://docs.aws.amazon.com/sdk-for-javascript/)

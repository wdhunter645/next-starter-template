# Backblaze B2 Cloud Storage Integration

This document describes the optional Backblaze B2 integration for the Next.js starter template.

## Overview

Backblaze B2 is an S3-compatible cloud storage service that can be used for storing and serving media files, backups, and other assets. This integration is **completely optional** and the application will function normally without it.

## Features

When configured, the B2 integration provides:

- **Admin-only presigned URLs** for secure file uploads (`/api/admin/b2/presign`)
- **Sync endpoint** (stub) for future bulk operations (`/api/admin/b2/sync`)
- **Graceful degradation** - Returns 503 with clear messaging when not configured
- **Admin gating** - All B2 endpoints require authentication via `ADMIN_EMAILS`

## Configuration

### 1. Create a Backblaze B2 Account

1. Sign up at [backblaze.com/b2](https://www.backblaze.com/b2/cloud-storage.html)
2. Create a new bucket (private recommended)
3. Note your bucket name and endpoint URL

### 2. Generate Application Keys

1. Go to **App Keys** in B2 dashboard
2. Create a new Application Key with access to your bucket
3. Save the Key ID and Application Key (shown only once!)

### 3. Set Environment Variables

Add these to your `.env` file (or Cloudflare Pages environment variables):

```bash
# Backblaze B2 Configuration
B2_KEY_ID=your_key_id_here
B2_APP_KEY=your_application_key_here
B2_BUCKET=your-bucket-name
B2_ENDPOINT=https://s3.us-west-000.backblazeb2.com
PUBLIC_B2_BASE_URL=https://your-custom-domain.com
```

**Endpoint URL format:**
- Find your region endpoint in B2 dashboard under "Buckets > Endpoint"
- Format: `https://s3.<region>.backblazeb2.com`
- Example: `https://s3.us-west-004.backblazeb2.com`

**Public URL:**
- Use a custom domain configured with B2
- Or use the default: `https://f000.backblazeb2.com/file/{bucket-name}/`

### 4. Configure Admin Access

Set the `ADMIN_EMAILS` environment variable with comma-separated admin emails:

```bash
ADMIN_EMAILS=admin@example.com,another-admin@example.com
```

## API Endpoints

### POST /api/admin/b2/presign

Generates a presigned URL for uploading files to B2.

**Authentication:** Requires admin session (placeholder: `x-user-email` header in development)

**Request:**
```json
{
  "key": "uploads/image.jpg",
  "contentType": "image/jpeg",
  "expiresIn": 300
}
```

**Response (success):**
```json
{
  "ok": true,
  "url": "https://s3.us-west-000.backblazeb2.com/...",
  "method": "PUT",
  "headers": { "Content-Type": "image/jpeg" },
  "expiresIn": 300
}
```

**Response (not configured):**
```json
{
  "ok": false,
  "reason": "B2 not configured",
  "missing": {
    "keyId": false,
    "appKey": false,
    "bucket": true,
    "endpoint": false
  }
}
```

**Response (not authorized):**
```json
{
  "ok": false,
  "error": "Not authenticated"
}
```

### GET /api/admin/b2/sync

Stub endpoint for future sync functionality.

**Authentication:** Requires admin session

**Response (success):**
```json
{
  "ok": true,
  "todo": "implement listing/sync later",
  "configured": true
}
```

**Response (not configured):**
```json
{
  "ok": false,
  "reason": "B2 not configured"
}
```

## Usage Example

```typescript
// Upload a file using presigned URL
async function uploadFile(file: File) {
  // 1. Get presigned URL from admin endpoint
  const response = await fetch('/api/admin/b2/presign', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // In production, use actual session token
      'x-user-email': 'admin@example.com',
    },
    body: JSON.stringify({
      key: `uploads/${file.name}`,
      contentType: file.type,
      expiresIn: 300,
    }),
  });

  const { url, headers } = await response.json();

  // 2. Upload file directly to B2
  const uploadResponse = await fetch(url, {
    method: 'PUT',
    headers: headers,
    body: file,
  });

  if (uploadResponse.ok) {
    console.log('Upload successful!');
  }
}
```

## Security Considerations

1. **Admin-only access** - All B2 operations require admin authentication
2. **No credentials exposure** - Keys never sent to client
3. **Time-limited URLs** - Presigned URLs expire (default 300 seconds)
4. **Server-side validation** - All requests validated on server

## Troubleshooting

### "B2 not configured" error

This is expected if you haven't set up B2. The application works fine without it.

To enable B2:
1. Verify all 4 environment variables are set
2. Check endpoint URL format matches your B2 region
3. Verify bucket name is correct

### "Not authenticated" error

Admin endpoints require authentication. In development, use the `x-user-email` header with an email listed in `ADMIN_EMAILS`.

In production, implement proper session management (e.g., via Supabase Auth).

### "Insufficient permissions" error

Your email must be listed in the `ADMIN_EMAILS` environment variable.

## Cost Considerations

Backblaze B2 pricing (as of 2024):
- **Storage**: $0.006/GB/month (first 10GB free)
- **Downloads**: $0.01/GB (first 1GB/day free)
- **API calls**: Free (no egress fees to Cloudflare)

B2 is typically more cost-effective than AWS S3 for long-term storage.

## Migration and Alternatives

This integration can be replaced with:
- **Cloudflare R2** - Similar S3-compatible API, zero egress fees
- **AWS S3** - Industry standard, extensive features
- **Supabase Storage** - Integrated with Supabase Auth

The presign pattern works the same across all S3-compatible storage providers.

## Future Enhancements

Planned features for the sync endpoint:
- List all objects in bucket
- Sync metadata with local database
- Bulk operations (delete, copy, move)
- Generate download URLs
- Manage bucket lifecycle rules

---

**Note:** This integration is optional and maintained separately from core application functionality. It will not block CI/CD pipelines if not configured.

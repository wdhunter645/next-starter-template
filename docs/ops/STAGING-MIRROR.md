# Staging Mirror & Refresh Plan

This document describes the staging environment setup, branch model, and refresh workflow for maintaining a production-like testing environment.

## Branch Model

### Production Branch: `main`
- **Purpose**: Production-ready code
- **Deployment**: Automatically deployed to production
- **URL**: `https://www.lougehrigfanclub.com`
- **Protection**: Branch protection rules, required reviews
- **Merge Policy**: PRs only, no direct commits

### Staging Branch: `staging`
- **Purpose**: Pre-production testing
- **Deployment**: Automatically deployed to staging environment
- **URL**: `https://test.lougehrigfanclub.com` (configured via Cloudflare Pages)
- **Protection**: Optional protection, can be updated more freely
- **Refresh**: Periodically synced from `main`

### Feature Branches
- **Pattern**: `feature/*`, `fix/*`, `chore/*`, etc.
- **Purpose**: Development work
- **Deployment**: Preview deployments via Cloudflare Pages
- **URL Pattern**: `https://[commit-hash].[project].pages.dev`
- **Lifecycle**: Merged to `staging` or `main`, then deleted

## Cloudflare Pages Configuration

### Production Deployment
- **Branch**: `main`
- **Domain**: `www.lougehrigfanclub.com`
- **Build Command**: `npm run build`
- **Output Directory**: `.next`
- **Environment**: Production

### Staging Deployment
- **Branch**: `staging`
- **Domain**: `test.lougehrigfanclub.com`
- **Build Command**: `npm run build`
- **Output Directory**: `.next`
- **Environment**: Staging

### Preview Deployments
- **Trigger**: Any PR or push to non-production branch
- **URL**: Auto-generated by Cloudflare Pages
- **Purpose**: Test changes before merging
- **Lifecycle**: Automatic, cleaned up after branch deletion

## Subdomain Mapping

Configure custom domain in Cloudflare Pages dashboard:

1. **Go to Pages Project** → Your Project → Custom Domains
2. **Add Custom Domain**: `test.lougehrigfanclub.com`
3. **Select Branch**: `staging`
4. **DNS**: Cloudflare automatically configures CNAME record

DNS Record (handled by Cloudflare):
```
Type: CNAME
Name: test
Target: [project-name].pages.dev
Proxy: Enabled (orange cloud)
```

## Refresh Workflow (Non-Destructive)

### Code Refresh
Sync staging branch with latest production code.

#### Option A: Fast-Forward Merge (Recommended)
```bash
# Ensure staging is behind or at main
git checkout staging
git fetch origin
git merge --ff-only origin/main

# If fast-forward succeeds
git push origin staging

# If fast-forward fails (staging has diverged)
# Use Option B instead
```

#### Option B: Rebase (When Staging Has Diverged)
```bash
# Fetch latest
git fetch origin

# Rebase staging onto main
git checkout staging
git rebase origin/main

# Resolve any conflicts if needed
# Then force push (safe if staging is just a mirror)
git push origin staging --force-with-lease

# Staging automatically re-deploys
```

#### Option C: Reset (Nuclear Option)
```bash
# CAUTION: This discards any staging-specific changes
git checkout staging
git reset --hard origin/main
git push origin staging --force

# Use only if staging should be identical to main
```

### Database Refresh (Supabase)

When Supabase is configured, refresh staging database:

#### 1. Snapshot Production Database
```bash
# Using Supabase CLI
supabase db dump --db-url "$PROD_SUPABASE_URL" > prod-snapshot.sql

# Or via Supabase Dashboard
# Settings → Database → Backup → Create Backup
```

#### 2. Mask PII (Important!)
```bash
# Edit prod-snapshot.sql to anonymize sensitive data
# Example: Replace real emails with test@example.com
sed -i 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/test@example.com/g' prod-snapshot.sql

# Mask phone numbers, addresses, etc.
# Use scripting or manual review for sensitive fields
```

#### 3. Restore to Staging Database
```bash
# Apply snapshot to staging
supabase db reset --db-url "$STAGING_SUPABASE_URL"
psql "$STAGING_SUPABASE_URL" < prod-snapshot.sql

# Or via Supabase Dashboard
# Settings → Database → Restore
```

#### Notes on Database Refresh
- **PII Masking**: Required by privacy regulations (GDPR, CCPA)
- **Data Subset**: Consider using only subset of data for staging
- **Test Data**: Add test-specific data after restore
- **Frequency**: Monthly or before major releases

### Media Refresh (B2 - Optional)

When B2 storage is configured, optionally sync media to staging:

#### Read-Only Sync (Recommended)
```bash
# Install B2 CLI
pip install b2

# Authorize
b2 authorize-account "$B2_KEY_ID" "$B2_APP_KEY"

# Sync from production bucket to staging (read-only)
b2 sync --noProgress \
  b2://prod-bucket-name \
  b2://staging-bucket-name \
  --replaceNewer

# Skip this in CI - run manually when needed
```

#### Notes on Media Sync
- **Optional**: Media sync is not required for code testing
- **Large Files**: Can be time-consuming, run during off-hours
- **Storage Costs**: Staging bucket incurs storage costs
- **Alternative**: Configure staging to read from production bucket (read-only)

## Day-2 Runbook

After refreshing staging, validate core functionality:

### 1. Smoke Tests
```bash
# Run smoke script against staging
./scripts/smoke.sh https://test.lougehrigfanclub.com
```

Expected: All tests pass (12/12)

### 2. Core Routes Validation
Manually verify in browser:
- [ ] Home page loads
- [ ] Navigation works (all links)
- [ ] Public pages accessible
- [ ] Protected pages show auth requirement

### 3. Admin Gate Validation
- [ ] `/admin` requires authentication
- [ ] Non-admin users denied access
- [ ] Admin users (from ADMIN_EMAILS) can access

### 4. API Endpoints Validation
Check key endpoints:
```bash
# Environment check
curl https://test.lougehrigfanclub.com/api/env/check

# Phase 2 status
curl https://test.lougehrigfanclub.com/api/phase2/status

# Supabase status
curl https://test.lougehrigfanclub.com/api/supabase/status
```

### 5. Environment Variables Check
Verify staging has correct environment variables set in Cloudflare Pages:
- Go to Pages → Settings → Environment Variables
- Check "Preview" environment (for staging branch)
- Ensure all required vars are set

### 6. Build Logs Review
Check Cloudflare Pages deployment logs:
- Go to Pages → Deployments → Latest Staging Deploy
- Review build logs for warnings/errors
- Verify build time is reasonable

## Maintenance Schedule

### Weekly
- Monitor staging deployment status
- Review preview deployment logs
- Clean up old preview branches

### Monthly
- Refresh staging code from main
- Refresh staging database (if applicable)
- Review and update environment variables

### Before Major Release
- Full staging refresh (code, DB, media)
- Complete day-2 runbook validation
- Performance testing on staging
- User acceptance testing

## Troubleshooting

### Staging deployment fails
1. Check Cloudflare Pages build logs
2. Verify environment variables are set
3. Test build locally: `npm run build`
4. Check for breaking changes in dependencies

### Staging out of sync with main
```bash
# Check divergence
git log staging..main

# Re-sync using refresh workflow above
```

### Database refresh fails
1. Check database connection strings
2. Verify Supabase credentials
3. Ensure sufficient disk space
4. Check for schema incompatibilities

### Smoke tests fail on staging
1. Review smoke script output
2. Check which specific tests fail
3. Verify environment configuration
4. Compare with production environment

## Security Considerations

1. **Different Credentials**: Staging should use separate credentials from production
2. **Data Masking**: Always mask PII when copying production data
3. **Access Control**: Limit who can deploy to staging
4. **Subdomain Separation**: Keeps staging cookies separate from production
5. **No Sensitive Testing**: Don't use real credit cards, real emails, etc.

## Related Documentation

- [Deployment Guide](../DEPLOYMENT_GUIDE.md)
- [Smoke Testing](./SMOKE.md)
- [Configuration Reference](../CONFIGURATION_REFERENCE.md)
- [Rollout Checklist](./ROLLOUT.md) (to be created)

## Cloudflare Pages Dashboard Links

- **Project Dashboard**: https://dash.cloudflare.com → Pages → [Your Project]
- **Custom Domains**: Pages → [Project] → Custom Domains
- **Environment Variables**: Pages → [Project] → Settings → Environment Variables
- **Deployments**: Pages → [Project] → Deployments

## Notes

- This is a non-destructive refresh workflow
- Staging can have temporary experimental changes
- Regular syncing keeps staging close to production
- Use staging for integration testing before production deploy

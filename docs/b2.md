# Backblaze B2 Operations

## Overview

This document describes the Backblaze B2 integration for the LGFC project, including storage operations, smoke testing, and daily inventory synchronization.

## B2 S3 Smoke Test

### Purpose

The B2 S3 smoke test provides a **connectivity-only validation** that GitHub Actions can successfully connect to Backblaze B2 via the S3-compatible endpoint. This test acts as a fail-fast signal for Day-2 workflows (like the B2 inventory → D1 sync) to ensure B2 access is correctly configured.

**This smoke test does NOT:**
- Perform inventory diffs
- Write to D1 database
- Modify any data

**This smoke test DOES:**
- Validate required environment variables are present
- Test S3 endpoint connectivity
- Verify bucket accessibility
- Confirm credentials are valid
- Return a sample object count (0-5 objects)

### Required Secrets

The following secrets must be configured in the GitHub repository settings (`Settings > Secrets and variables > Actions`):

| Secret Name | Description | Example Value |
|-------------|-------------|---------------|
| `B2_BUCKET` | Backblaze B2 bucket name | `lgfc-photos` |
| `B2_ENDPOINT` | S3-compatible endpoint URL | `https://s3.us-west-002.backblazeb2.com` |
| `B2_KEY_ID` | B2 application key ID | `005a1b2c3d4e5f6g7h8i9j0k` |
| `B2_APP_KEY` | B2 application key (secret) | `K005AbCdEfGhIjKlMnOpQrStUvWxYz` |

### Endpoint Format

Backblaze B2 S3-compatible endpoints follow this pattern:

```
https://s3.<region>.backblazeb2.com
```

**Examples:**
- `https://s3.us-west-002.backblazeb2.com`
- `https://s3.us-west-004.backblazeb2.com`
- `https://s3.eu-central-003.backblazeb2.com`

The region code can be found in your Backblaze B2 bucket settings.

### Running the Smoke Test Manually

#### Via GitHub Actions (Recommended)

1. Navigate to the **Actions** tab in the GitHub repository
2. Select the **"B2 S3 Smoke Test"** workflow from the left sidebar
3. Click the **"Run workflow"** button
4. Select the branch (usually `main`)
5. Click **"Run workflow"** to start

#### Via Command Line (Local or CI)

```bash
# Ensure required environment variables are set
export B2_BUCKET="your-bucket-name"
export B2_ENDPOINT="https://s3.us-west-002.backblazeb2.com"
export B2_KEY_ID="your-key-id"
export B2_APP_KEY="your-app-key"

# Run the smoke test script
bash scripts/b2_s3_smoketest.sh
```

### Expected Successful Output

When the smoke test succeeds, you should see output similar to:

```
============================================
B2 S3 Smoke Test
============================================

✓ Environment variables validated
✓ Testing connectivity to B2 bucket via S3 endpoint...

============================================
✓ SUCCESS: B2 S3 connectivity verified
============================================

Bucket: lgfc-photos
Objects sampled: 5 (max 5)

B2 S3 endpoint is reachable and credentials are valid.
```

### Expected Failure Scenarios

#### Missing Environment Variables

```
============================================
B2 S3 Smoke Test
============================================

ERROR: Missing required environment variables:
  - B2_BUCKET
  - B2_ENDPOINT

Please ensure all required secrets are configured in GitHub repository settings.
```

#### Invalid Credentials or Endpoint

```
============================================
B2 S3 Smoke Test
============================================

✓ Environment variables validated
✓ Testing connectivity to B2 bucket via S3 endpoint...

ERROR: Failed to connect to B2 bucket

AWS CLI output:
An error occurred (InvalidAccessKeyId) when calling the ListObjectsV2 operation: ...

Please verify:
  - B2_ENDPOINT is correct (format: https://s3.<region>.backblazeb2.com)
  - B2_BUCKET name is correct
  - B2_KEY_ID and B2_APP_KEY are valid and have read permissions
```

## B2 Daily Inventory Sync

The B2 daily inventory sync (separate workflow) uses the smoke test as a prerequisite to ensure B2 connectivity before attempting inventory operations and D1 database updates.

### Related Workflows

- **B2 S3 Smoke Test** (`.github/workflows/b2-s3-smoketest.yml`) - Connectivity validation only
- **B2 → D1 Daily Sync** (`.github/workflows/b2-d1-daily-sync.yml`) - Full inventory sync with D1 upserts

## Security Considerations

- **No secrets are logged** - The smoke test script explicitly avoids echoing any secret values to logs
- **Read-only permissions** - The smoke test workflow uses default read permissions only
- **Minimal data exposure** - Only object counts (0-5) are displayed, not object keys or metadata

## Troubleshooting

### AWS CLI Not Found

If you see `aws: command not found`, ensure AWS CLI v2 is installed:

```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip
unzip -q /tmp/awscliv2.zip -d /tmp
sudo /tmp/aws/install
aws --version
```

### JQ Not Found

If you see `jq: command not found`, install jq:

```bash
sudo apt-get update
sudo apt-get install -y jq
```

### Invalid Endpoint Error

If you receive an endpoint-related error, verify:
1. The endpoint URL starts with `https://`
2. The endpoint follows the pattern `https://s3.<region>.backblazeb2.com`
3. The region matches your B2 bucket's region (found in Backblaze dashboard)

### Permission Denied Errors

If you see permission errors:
1. Verify the B2 application key has **read** permissions for the bucket
2. Check that the key hasn't expired
3. Confirm the bucket name is spelled correctly (case-sensitive)

## Additional Resources

- [Backblaze B2 S3 Compatible API Documentation](https://www.backblaze.com/b2/docs/s3_compatible_api.html)
- [AWS CLI S3 API Command Reference](https://docs.aws.amazon.com/cli/latest/reference/s3api/)

# Cloudflare Worker Deployment Configuration

## Overview

This repository has been configured to deploy to Cloudflare **Workers** (not Pages) to target the production Worker `next-starter-template` that owns the route `www.lougehrigfanclub.com/*`.

## Changes Made

### 1. New Wrangler Configuration (`wrangler.toml`)

- **Worker Name**: `next-starter-template` (must match the production Worker on Cloudflare)
- **Main Entry**: `.open-next/worker.js` (generated by OpenNext build)
- **Compatibility Date**: `2024-09-23` (required for modern Node.js compatibility)
- **Assets**: Configured to serve static files from `.open-next/assets`

### 2. New Deployment Workflow (`.github/workflows/deploy-cloudflare.yml`)

- Triggers on every push to `main` branch
- Triggers on manual workflow dispatch
- Steps:
  1. Checkout code
  2. Install Node.js 20
  3. Install dependencies (`npm ci`)
  4. Build with OpenNext (`npx opennextjs-cloudflare build`)
  5. Verify build output
  6. Deploy to Cloudflare Worker using `wrangler deploy`

### 3. Disabled Workflows

The following workflows were disabled (renamed to `.disabled`) as they are specific to Cloudflare Pages deployment:

- `deploy.yml` - Pages deployment workflow
- `cloudflare-rollback.yml` - Pages rollback workflow
- `review-builds.yml` - Pages build review workflow

### 4. Removed Configuration

- `wrangler.jsonc` - The old Cloudflare Pages configuration

## Required GitHub Secrets

The deployment workflow requires these secrets to be configured in the repository:

1. **CLOUDFLARE_API_TOKEN** - API token with "Workers Scripts: Edit" permission
2. **CLOUDFLARE_ACCOUNT_ID** - Your Cloudflare account ID

## Deployment Process

### Automatic Deployment

Every push to the `main` branch automatically:
1. Builds the Next.js application with OpenNext
2. Deploys to the `next-starter-template` Worker
3. Makes the deployment active on `www.lougehrigfanclub.com/*`

### Manual Deployment

You can manually trigger a deployment:
1. Go to GitHub Actions
2. Select "Deploy to Cloudflare (prod)" workflow
3. Click "Run workflow"
4. Select the `main` branch
5. Click "Run workflow"

### Local Development

For local development and testing:
```bash
# Development server
npm run dev

# Build locally
npm run build

# Build and preview with OpenNext
npm run preview

# Local deploy (for testing)
npm run deploy
```

## Verification After Merge

After this PR is merged, verify the deployment:

1. **Check GitHub Actions**
   - Go to Actions tab
   - Verify "Deploy to Cloudflare (prod)" workflow runs successfully
   - Check for green checkmark

2. **Check Cloudflare Dashboard**
   - Go to Workers & Pages → Workers
   - Find `next-starter-template` worker
   - Verify it shows route `www.lougehrigfanclub.com/*`
   - Check "Deployments" tab for new deployment with "Active" status
   - Verify timestamp matches the GitHub Actions run

3. **Test Production Site**
   - Visit `https://www.lougehrigfanclub.com/`
   - Verify the site loads correctly
   - If stale, perform a cache purge in Cloudflare and recheck

4. **Cleanup (Optional)**
   - In Cloudflare Dashboard, delete the stray `spring-frost-7a2c` worker if it exists
   - It has no production routes and was being deployed to by mistake

## Important Notes

- We are **not** using a staging environment initially
- All deployments go directly to production
- The worker bundle is emitted at `.open-next/worker.js` by the OpenNext build
- Staging environments can be added later using `[env.staging]` in `wrangler.toml` with a different worker name

## Rollback

If you need to rollback to a previous deployment, use the Cloudflare Dashboard:
1. Go to Workers & Pages → `next-starter-template` → Deployments
2. Find the previous deployment you want to restore
3. Click "Promote to production" or use the Cloudflare API

Note: The automated rollback workflow was for Pages and is not compatible with Workers.

## Troubleshooting

### Deployment fails with authentication error
- Verify `CLOUDFLARE_API_TOKEN` has "Workers Scripts: Edit" permission
- Verify `CLOUDFLARE_ACCOUNT_ID` is correct

### Build succeeds but deployment fails
- Check that `.open-next/worker.js` exists after build
- Verify wrangler.toml configuration is correct

### Site shows old content after deployment
- Perform a cache purge in Cloudflare Dashboard
- Clear your browser cache
- Check Cloudflare Dashboard to confirm deployment is "Active"

### Wrong worker being deployed to
- Verify `wrangler.toml` has `name = "next-starter-template"`
- Check Cloudflare Dashboard for the correct worker name
- Ensure no other wrangler.toml or wrangler.jsonc files exist in the repo

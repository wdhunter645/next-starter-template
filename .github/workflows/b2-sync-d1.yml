name: B2 → D1 Photo Sync

on:
  workflow_dispatch:
    inputs:
      prefix:
        description: "Optional B2 key prefix to sync (e.g., photos/)"
        required: false
        default: ""
      dry_run:
        description: "If true, generate SQL but do not execute D1 updates"
        required: false
        default: "false"
  schedule:
    - cron: "23 6 * * *" # daily 06:23 UTC

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Install AWS CLI (if missing)
        run: |
          if ! command -v aws >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y awscli
          fi

      - name: Run B2 → D1 sync
        env:
          # Cloudflare (required for D1 remote execute)
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          # B2 S3 credentials + config (user said these are already set as repo secrets)
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
          B2_ENDPOINT: ${{ secrets.B2_ENDPOINT }}
          B2_BUCKET: ${{ secrets.B2_BUCKET }}
          PUBLIC_B2_BASE_URL: ${{ secrets.PUBLIC_B2_BASE_URL }}

          # Inputs
          B2_PREFIX: ${{ github.event.inputs.prefix }}
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' && '1' || '' }}
          D1_DB_NAME: lgfc_lite
        run: |
          bash scripts/b2_sync_to_d1.sh

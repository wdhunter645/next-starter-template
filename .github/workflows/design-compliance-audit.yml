name: Design Compliance Audit (Alert-Only)

# Purpose: Monitor and report misalignment between as-built production behavior
# and documented design expectations.
#
# - Alert-only: always green ✅ regardless of audit results
# - Non-blocking: NOT added to required PR checks
# - Observability-only: no auto-fixing, no commits from CI
# - PR runs: SKIPPED (no preview URL; no production fallback)
# - Production runs: main branch, nightly schedule, manual dispatch

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - main
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  audit:
    name: Design Compliance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
      
      - name: Determine target URL
        id: target
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, we need the Cloudflare preview URL
            # Since we don't have access to it yet, SKIP the audit
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "context=PR (preview URL not available - skipping audit)" >> $GITHUB_OUTPUT
            echo "url=" >> $GITHUB_OUTPUT
            echo "Skipping audit for PR - preview URL integration not yet implemented"
          else
            # For main branch and nightly runs, use production
            TARGET_URL="https://www.lougehrigfanclub.com"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "context=production" >> $GITHUB_OUTPUT
            echo "url=$TARGET_URL" >> $GITHUB_OUTPUT
            echo "Testing against: $TARGET_URL (${{ github.event_name }})"
          fi
      
      - name: Run design compliance audit
        id: audit
        if: steps.target.outputs.skip != 'true'
        continue-on-error: true
        env:
          TARGET_URL: ${{ steps.target.outputs.url }}
        run: |
          echo "Running audit against: $TARGET_URL"
          echo "Context: ${{ steps.target.outputs.context }}"
          echo ""
          
          node scripts/ci/design-compliance-audit.mjs | tee /tmp/audit-report.txt
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: design-compliance-audit-report
          path: /tmp/audit-report.txt
          retention-days: 30
      
      - name: Audit summary
        if: always()
        run: |
          echo "## Design Compliance Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ steps.target.outputs.url || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Context:** ${{ steps.target.outputs.context }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.target.outputs.skip }}" = "true" ]; then
            echo "⏭️ **Status:** Audit skipped (preview URL not available for PRs)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The audit will run automatically once Cloudflare preview URL integration is implemented." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.audit.outcome }}" = "success" ]; then
            echo "✅ **Status:** All checks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.audit.outcome }}" = "failure" ]; then
            echo "⚠️ **Status:** Mismatches detected (see job logs and artifact for details)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is an **alert-only** audit. The workflow is green and does not block merges." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the audit report artifact and triage each mismatch as:" >> $GITHUB_STEP_SUMMARY
            echo "- **Code fix:** as-built should match as-designed, OR" >> $GITHUB_STEP_SUMMARY
            echo "- **Doc update:** as-designed should match as-built" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **Status:** Audit step was skipped or did not run" >> $GITHUB_STEP_SUMMARY
          fi

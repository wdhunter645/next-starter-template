name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [staging, production]
        default: staging
      branch:
        description: "Git branch to deploy from"
        required: true
        default: main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CF_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build Next & prepare Pages artifact
        run: npm run cf:build

      - name: Install Wrangler (for idempotent project create)
        run: npm i -g wrangler

      - name: Ensure Pages project exists
        run: |
          set -e
          if [ "${{ inputs.environment }}" = "production" ]; then PROJ="lgfc-prod"; else PROJ="lgfc-staging"; fi
          # If the list fails, show the error and exit for clarity
          wrangler pages project list || (echo "Failed to list Pages projects"; exit 1)
          wrangler pages project list | grep -q "$PROJ" || wrangler pages project create "$PROJ" --production-branch main

      - name: Deploy via cloudflare/pages-action
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ inputs.environment == 'production' && 'lgfc-prod' || 'lgfc-staging' }}
          directory: .vercel/output/static
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Output next steps
        run: |
          echo "::notice::Deployed ${{ inputs.environment }}. See Cloudflare Pages dashboard for the exact URL."

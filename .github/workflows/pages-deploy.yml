name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [staging, production]
        default: staging
      branch:
        description: "Git branch to deploy from"
        required: true
        default: main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CF_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4
        with: { ref: ${{ inputs.branch }} }

      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }

      - run: npm ci
      - run: npm run cf:build
      - run: npm i -g wrangler

      - name: Ensure Pages project exists
        run: |
          set -e
          if [ "${{ inputs.environment }}" = "production" ]; then PROJ="lgfc-prod"; else PROJ="lgfc-staging"; fi
          wrangler pages project list | grep -q "$PROJ" || wrangler pages project create "$PROJ" --production-branch main

      - name: Deploy to Cloudflare Pages
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            wrangler pages deploy .vercel/output/static --project-name lgfc-prod --branch main --commit-dirty=true
          else
            wrangler pages deploy .vercel/output/static --project-name lgfc-staging
          fi

      - name: Echo next steps
        run: echo "Deployment done for ${{ inputs.environment }}. Check Pages dashboard for the URL."

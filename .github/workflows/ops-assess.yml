name: OPS — Site Assessment

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  assess:
    name: Run Site Assessment
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run assessment
        id: assess
        continue-on-error: true
        run: npm run assess:ci
      
      - name: Upload assessment report (JSON)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: assess-report-json
          path: reports/assess/assess-report.json
          retention-days: 90
      
      - name: Upload assessment summary (Markdown)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: assess-summary-md
          path: reports/assess/assess-summary.md
          retention-days: 90
      
      - name: Upload routes found
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: routes-found
          path: reports/assess/routes-found.json
          retention-days: 90
      
      - name: Create issue on failure
        if: failure() && (github.event_name == 'schedule' || github.event_name == 'push')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Site Assessment Failure Detected';
            const label = 'assessment-failure';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = `## ⚠️ Site Assessment Failed
            
            **Trigger:** ${context.eventName}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha.substring(0, 7)}
            **Run:** ${runUrl}
            
            The site assessment has detected issues. Please review the workflow logs and uploaded artifacts for details.
            
            ### Next Steps
            1. Download and review the assessment artifacts from the workflow run
            2. Check for missing routes, navigation issues, or page marker problems
            3. Fix the issues and verify with \`npm run assess\` locally
            4. Close this issue once resolved
            `;
            
            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: label
            });
            
            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `New failure detected:\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: [label]
              });
            }

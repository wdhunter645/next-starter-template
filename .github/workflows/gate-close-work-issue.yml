name: gate-close-work-issue

on:
  pull_request_target:
    types: [closed]

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  close-work-issue:
    runs-on: ubuntu-latest
    concurrency:
      group: gate-close-work-issue-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Close work-tracking Issue when PR closes
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title || `PR #${prNumber}`;
            const prUrl = context.payload.pull_request.html_url;
            const merged = !!context.payload.pull_request.merged;
            const issueKey = `[Work][PR #${prNumber}]`;

            const q = `repo:${owner}/${repo} type:issue in:title "${issueKey}"`;
            const res = await github.rest.search.issuesAndPullRequests({ q, per_page: 10 });
            const items = res.data.items || [];
            const issue = items.find(i => i.pull_request === undefined) || null;

            if (!issue) {
              core.info(`No work-tracking Issue found for ${issueKey}; nothing to close.`);
              return;
            }

            const statusLine = merged
              ? `✅ PR merged; closing tracker issue.`
              : `⚠️ PR closed without merge; closing tracker issue.`;

            const msg =
              `${statusLine}\n\n` +
              `PR: ${prUrl}\n` +
              `Issue Key: ${issueKey}\n` +
              `PR Title: ${prTitle}`;

            // Comment then close (idempotent).
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: msg,
              });
            } catch (e) {
              core.info("Unable to comment on tracker issue; continuing to close.");
            }

            // Only close if still open.
            if (issue.state === "open") {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issue.number,
                state: "closed",
              });
            }

